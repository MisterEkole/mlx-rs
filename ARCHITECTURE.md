# MLX-RS Architecture

## System Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                     Your Rust Application                        │
│                   (uses safe, idiomatic API)                     │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ use mlx::{Array, Dtype};
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    mlx crate (Safe Layer)                        │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │  pub struct Array {                                         │ │
│ │      ptr: *mut sys::mlx_array,                             │ │
│ │  }                                                          │ │
│ │                                                             │ │
│ │  impl Array {                                              │ │
│ │      pub fn add(&self, other: &Array) -> Result<Array>    │ │
│ │      pub fn multiply(&self, other: &Array) -> Result<...> │ │
│ │      pub fn eval(&self)                                    │ │
│ │  }                                                          │ │
│ │                                                             │ │
│ │  impl Drop for Array { ... }  // Automatic cleanup         │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│  Features:                                                        │
│  • Type safety (Dtype enum)                                      │
│  • Memory safety (Drop trait)                                    │
│  • Error handling (Result<T, Error>)                             │
│  • Thread safety (Send + Sync)                                   │
└────────────────────────┬─────────────────────────────────────────┘
                         │
                         │ use mlx_sys::*;
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                  mlx-sys crate (FFI Layer)                       │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │  #[repr(C)]                                                 │ │
│ │  pub struct mlx_array { _private: [u8; 0] }                │ │
│ │                                                             │ │
│ │  extern "C" {                                              │ │
│ │      pub fn mlx_array_new() -> *mut mlx_array;            │ │
│ │      pub fn mlx_array_free(arr: *mut mlx_array);          │ │
│ │      pub fn mlx_add(a, b) -> *mut mlx_array;              │ │
│ │      pub fn mlx_multiply(a, b) -> *mut mlx_array;         │ │
│ │      pub fn mlx_eval(arr: *mut mlx_array);                │ │
│ │  }                                                          │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│  Generated by:                                                    │
│  • bindgen (when MLX_C_PATH set)                                 │
│  • OR placeholder types (for development)                        │
└────────────────────────┬─────────────────────────────────────────┘
                         │
                         │ C ABI / dylib
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                   mlx-c (C API) - libmlxc.dylib                  │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │  mlx_array mlx_add(mlx_array a, mlx_array b) {             │ │
│ │      return mlx::core::add(a, b);  // C++ call             │ │
│ │  }                                                          │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│  Purpose: Bridge between C and C++ APIs                          │
└────────────────────────┬─────────────────────────────────────────┘
                         │
                         │ C++ function calls
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    MLX (C++ Core Library)                        │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │  namespace mlx::core {                                      │ │
│ │      array add(const array& a, const array& b);            │ │
│ │      array multiply(const array& a, const array& b);       │ │
│ │      void eval(array& a);                                  │ │
│ │  }                                                          │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│  Features:                                                        │
│  • Lazy evaluation & computation graphs                          │
│  • Unified memory (CPU + GPU)                                    │
│  • Metal shader execution                                        │
│  • Automatic differentiation                                     │
└────────────────────────┬─────────────────────────────────────────┘
                         │
                         │ Metal API
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Apple Metal (GPU Backend)                      │
│                                                                   │
│  • GPU kernels                                                   │
│  • Unified memory access                                         │
│  • Hardware acceleration on Apple Silicon                        │
└─────────────────────────────────────────────────────────────────┘
```

## Build Process Flow

```
Developer runs: cargo build --features mlx-c-bindings
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  build.rs (mlx-sys)                                     │
│  1. Check if MLX_C_PATH is set                          │
│  2. Find mlx/c/mlx.h header                            │
│  3. Run bindgen                                         │
│  4. Generate bindings.rs                                │
│  5. Link against libmlxc.dylib                         │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  Generated bindings.rs                                  │
│  (included in mlx-sys/src/lib.rs)                      │
│                                                          │
│  Contains:                                               │
│  • All C function declarations                          │
│  • All C struct definitions                             │
│  • All C enum definitions                               │
│  • All C constants                                      │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  mlx crate links against mlx-sys                        │
│  Provides safe wrappers                                 │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
              Final library compiled
```

## Memory Management

```
Rust Code:                         C++ Memory:
─────────────                      ─────────────

let arr = Array::from_slice(...)  → mlx::core::array created
    │                                      │
    │ Array { ptr: 0x1234 }               │ ref_count = 1
    │                                      │
    ├─ arr.add(&other)                → creates new array
    │      │                                  │ ref_count = 1
    │      └─ returns Array                   │
    │                                         │
    └─ Drop runs when arr                    │
       goes out of scope                     │
           │                                  │
           └─ mlx_array_free(ptr)        → ref_count--
                   │                          │
                   └──────────────────────> if ref_count == 0:
                                              deallocate
```

## Data Flow Example

```
User Code:
──────────
let a = Array::from_slice(&[1.0, 2.0], &[2], Dtype::Float32)?;
let b = Array::from_slice(&[3.0, 4.0], &[2], Dtype::Float32)?;
let c = a.add(&b)?;
c.eval();

Flow:
─────
1. Array::from_slice()
   ↓
2. mlx_array_from_data() [mlx-sys]
   ↓
3. mlx::core::array::from_data() [C++]
   ↓
4. Metal buffer allocated (unified memory)
   ↓
5. Returns mlx_array handle
   ↓
6. Wrapped in Rust Array struct

7. a.add(&b)
   ↓
8. mlx_add(a.ptr, b.ptr) [mlx-sys]
   ↓
9. mlx::core::add() [C++]
   ↓
10. Creates computation graph node (lazy)
    ↓
11. Returns new mlx_array handle
    ↓
12. Wrapped in Rust Array struct

13. c.eval()
    ↓
14. mlx_eval(c.ptr) [mlx-sys]
    ↓
15. mlx::core::eval() [C++]
    ↓
16. Traverses computation graph
    ↓
17. Compiles Metal kernels
    ↓
18. Executes on GPU
    ↓
19. Materializes result
```

## Type System Mapping

```
Rust (mlx)          mlx-sys             mlx-c              MLX C++
──────────          ───────             ─────              ───────

Dtype::Float32  →   MLX_FLOAT32    →   MLX_FLOAT32    →   float32
Dtype::Int32    →   MLX_INT32      →   MLX_INT32      →   int32_t
Dtype::Bool     →   MLX_BOOL       →   MLX_BOOL       →   bool

Array           →   *mut mlx_array →   mlx_array      →   mlx::core::array
                    (opaque pointer)    (opaque handle)    (C++ object)

Result<Array>   →   *mut mlx_array →   mlx_array      →   mlx::core::array
                    (null check)        (or NULL)          (or exception)
```

## Safety Layers

```
┌─────────────────────────────────────────────────────────┐
│  Rust Type System                                       │
│  • Ownership prevents use-after-free                    │
│  • Borrowing prevents data races                        │
│  • Drop guarantees cleanup                              │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  mlx crate (Safe Rust)                                  │
│  • Null pointer checks                                  │
│  • Error propagation (Result)                           │
│  • RAII via Drop                                        │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  mlx-sys (Unsafe Rust)                                  │
│  • Raw pointers                                         │
│  • extern "C" functions                                 │
│  • No Rust safety guarantees                            │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  mlx-c (C API)                                          │
│  • Stable C ABI                                         │
│  • Reference counting                                   │
│  • Opaque handles                                       │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  MLX C++                                                │
│  • std::shared_ptr                                      │
│  • RAII                                                 │
│  • Exception safety                                     │
└─────────────────────────────────────────────────────────┘
```
